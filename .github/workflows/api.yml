name: 'Deploy API'
on:
  push:
    branches:
      - master
    paths:
      - '.github/workflows/api.yml'
      - 'packages/api/**'
      - 'packages/common/**'

jobs:
  api:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1

      - name: Uses Node.js 14
        uses: actions/setup-node@v1
        with:
          node-version: 14

      - name: Build image
        run: |
          echo Building the Docker image...
          docker build -t api packages/api
          docker tag api:latest 719104767000.dkr.ecr.eu-west-1.amazonaws.com/api:latest
      
      - name: Push to AWS ECR
        run: |
          echo Logging in to Amazon ECR...

          $(aws ecr get-login-password --region eu-west-1 | docker login --username AWS --password-stdin 719104767000.dkr.ecr.eu-west-1.amazonaws.com)

          echo Pushing the Docker images...
          docker push 719104767000.dkr.ecr.eu-west-1.amazonaws.com/api:latest
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      